


<!DOCTYPE html>
<html>
<head>
    <title>libopenmpt S3M Player</title>
</head>
<body>
    <input type="file" id="fileInput" accept=".s3m,.mod,.xm,.it">
    <button id="playButton" disabled>Play</button>
    <button id="pauseButton" disabled>Pause</button>
    <button id="stopButton" disabled>Stop</button>
    <div id="info"></div>

    <script src="libopenmpt.js"></script>
    <script>

        /***
         * 
         *      Code generated by Claude Sonnet. 
         * 
         */

        let modulePtr = null;
        let leftBufferPtr = null;
        let rightBufferPtr = null;
        let audioContext = null;
        let moduleInstance = null;
        let isPlaying = false;
        let scriptNode = null;

        // Create OpenMPT instance
        const createOpenMPTInstance = () => {
            return new Promise((resolve) => {
                if (typeof Module !== 'undefined') {
                    resolve(Module);
                } else {
                    // Module is not yet loaded, wait for it
                    Module = {
                        onRuntimeInitialized: () => {
                            resolve(Module);
                        }
                    };
                }
            });
        };

        // Initialize libopenmpt
        const initializeLibOpenmpt = async () => {
            try {
                moduleInstance = await createOpenMPTInstance();
                console.log('libopenmpt initialized successfully');
            } catch (error) {
                console.error('Failed to initialize libopenmpt:', error);
            }
        };

        // Handle file selection
        document.getElementById('fileInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const arrayBuffer = await file.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);
            
            // Create buffer for the module
            const byteArray = moduleInstance._malloc(uint8Array.byteLength);
            moduleInstance.HEAPU8.set(uint8Array, byteArray);

            // Create module
            modulePtr = moduleInstance._openmpt_module_create_from_memory(
                byteArray, uint8Array.byteLength, 0, 0, 0
            );

            if (modulePtr === 0) {
                alert('Error loading module!');
                return;
            }

            // Create audio buffers
            const BUFFER_SIZE = 4096;
            leftBufferPtr = moduleInstance._malloc(BUFFER_SIZE * 4);
            rightBufferPtr = moduleInstance._malloc(BUFFER_SIZE * 4);

            // Enable buttons
            document.getElementById('playButton').disabled = false;
            document.getElementById('pauseButton').disabled = false;
            document.getElementById('stopButton').disabled = false;

            // Show module info
            const duration = moduleInstance._openmpt_module_get_duration_seconds(modulePtr);
            document.getElementById('info').textContent = 
                `Duration: ${Math.floor(duration / 60)}:${Math.floor(duration % 60).toString().padStart(2, '0')}`;
        });

        // Play button handler
        document.getElementById('playButton').addEventListener('click', () => {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            if (!isPlaying) {
                const BUFFER_SIZE = 4096;
                scriptNode = audioContext.createScriptProcessor(BUFFER_SIZE, 0, 2);
                
                scriptNode.onaudioprocess = (e) => {
                    const left = e.outputBuffer.getChannelData(0);
                    const right = e.outputBuffer.getChannelData(1);
                    
                    const framesRendered = moduleInstance._openmpt_module_read_float_stereo(
                        modulePtr,
                        audioContext.sampleRate,
                        BUFFER_SIZE,
                        leftBufferPtr,
                        rightBufferPtr
                    );

                    if (framesRendered === 0) {
                        stopPlayback();
                        return;
                    }

                    const leftBuffer = new Float32Array(
                        moduleInstance.HEAPF32.buffer,
                        leftBufferPtr,
                        BUFFER_SIZE
                    );
                    const rightBuffer = new Float32Array(
                        moduleInstance.HEAPF32.buffer,
                        rightBufferPtr,
                        BUFFER_SIZE
                    );

                    left.set(leftBuffer);
                    right.set(rightBuffer);
                };

                scriptNode.connect(audioContext.destination);
                isPlaying = true;
            }

            audioContext.resume();
        });

        // Pause button handler
        document.getElementById('pauseButton').addEventListener('click', () => {
            if (audioContext) {
                audioContext.suspend();
            }
        });

        // Stop button handler
        document.getElementById('stopButton').addEventListener('click', stopPlayback);

        function stopPlayback() {
            if (scriptNode) {
                scriptNode.disconnect();
                scriptNode = null;
            }
            if (modulePtr) {
                moduleInstance._openmpt_module_set_position_seconds(modulePtr, 0);
            }
            isPlaying = false;
        }

        // Initialize when page loads
        initializeLibOpenmpt();

        // Cleanup when page unloads
        window.addEventListener('beforeunload', () => {
            if (modulePtr) {
                moduleInstance._openmpt_module_destroy(modulePtr);
                moduleInstance._free(leftBufferPtr);
                moduleInstance._free(rightBufferPtr);
            }
        });
    </script>
</body>
</html>
